---
title: "Almond Yield Model, Group C"
output: html_document
---

# Setup

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(knitr)
library(kableExtra)
library(purrr)
library(ggpubr)

source('yield_model.R')
source('profit_model.R')
options(knitr.table.format = "latex",
        scipen = 999) 
```

```{r load_data, message = FALSE}
# Read in climate data
clim <- read_delim("./clim.txt", delim=" ")
```

# Assignment 2 - Almond Yield Function

## Compute Yield

```{r model_yield_table}
model_results <- yield_model(clim)

kable(model_results %>% 
        rename(Year = year, "Almond Yield Anomaly (ton/acre)" = almond_yield), 
      digits=4,
      caption = "Modeled Almond Yield Anomaly 1989-2010",
      format = "html",
      table.attr = "style='width:50%;'") %>% 
  kable_classic() %>% 
  kable_styling(bootstrap_options = c("striped", "hover"),
                position = "left"
                )
```

## Visualize Yield

```{r model_yield_plot, warning = FALSE}
ggplot(data = model_results, aes(x = year, y = almond_yield)) +
  geom_line() +
  geom_point() +
  theme_light() +
  labs(x = "Year",
       y = "Almond Yield Anomaly (ton/acre)",
       title = "Modeled Almond Yield Anomaly 1989-2010")
```

## Additional Exploration

```{r}
rain <- clim %>% 
  group_by(year) %>% 
  summarize(sum_precip = sum(precip))

rain_yield <- full_join(model_results, rain)

ggplot(data = rain, aes(x = year, y = sum_precip)) + 
  geom_line() +
  geom_point() +
  theme_light() +
  labs(x = "Year",
       y = "Precipitation (mm)",
       title = "Yearly Precipitation 1989-2010")
  
```

```{r}
linear_model <- lm(data = rain_yield, almond_yield ~ sum_precip)

summary.lm(linear_model)

ggplot(data = rain_yield, aes(x = sum_precip, y = almond_yield)) +
  geom_point() +
  geom_smooth(method = "lm") +
  theme_light()
```

Our findings demonstrate four years of almond yields below the anomaly (1989, 1999, 2003, 2004). Noticeable spikes in almond yield occur in 1995, 2005 and 2008. There seems to be a general pattern regarding consecutive years of yields slightly above/below the anomaly with on year spikes occurring every few years. By plotting annual precipitation, we see a similar pattern in the data, with high rainfall generally correlating with high almond yields. The linear regression also supports the correlation.

# Assignment 3 - Almond Profit Sensitivity

## Compute Simple Profit Model

```{r}
profit <- profit_model(yield_results = model_results)

p1 = ggplot(profit, aes(x=year, y=profit)) +
  geom_line() +
  theme_light() +
  labs(y="Profit", x="Year")

p2 = ggplot(profit, aes(x=year, y=almond_yield)) +
  geom_line() +
  theme_light() +
  labs(y="Almond Yield", x="Year")

ggarrange(p1, p2)
```

## Simple Informal Sensitivity Analysis

* Assume uncertainty in *temp_param2* and *precip_param2* parameters

* Default values from the function are -0.0046 and 0.0043, respectively

```{r}
nsamples = 50
deviation = 0.001
base_temp = -0.0046
base_precip = 0.0043

# Create normal distributions of both parameters 
temp_param2 = rnorm(mean = base_temp, sd = deviation, n = nsamples)
precip_param2 = rnorm(mean = base_precip, sd = deviation, n = nsamples)

# Combine into data frame
params = cbind.data.frame(temp_param2, precip_param2)

# Run yield model on all parameter combinations
results = params %>% pmap(yield_model, clim=clim,
                          temp_param=-0.015, precip_param=-0.07, intercept=0.28,
                          year_start=min(clim$year), year_end=max(clim$year))

# Extract results
mean_yield = map_df(results, `[`, c("year", "almond_yield"))
mean_yield = cbind.data.frame(mean_yield, params)

# Plot results
p1 = ggplot(mean_yield, 
            aes(temp_param2, almond_yield, col=precip_param2)) +
  geom_point(cex=2) +
  theme_light() +
  labs(y="Mean Annual Almond_Yield", 
       x="Temperature Coefficient")

p2 = ggplot(mean_yield, 
            aes(precip_param2, almond_yield, col=temp_param2)) + 
  geom_point(cex=2) +
  theme_light() +
  labs(y="Mean Annual Almond Yield", 
       x="Precipitation Coefficient")

ggarrange(p1, p2)
```

```{r}
# Investigate parameter space
ggplot(mean_yield, aes(x=temp_param2, y=precip_param2)) +
  geom_point() +
  theme_light() +
  labs(x="Temperature Coefficient",
       y="Precipitation Coefficient",
       title="Visualization of Parameter Sets")
```

## Almond Profit Uncertainty

```{r}
profit_sensitivity <- profit_model(yield_results = mean_yield)

# Plot results
# p1 = ggplot(profit_sensitivity, 
#             aes(temp_param2, profit)) +
#   geom_point(cex=2) +
#   theme_light() +
#   labs(y="Profit", 
#        x="Temperature Coefficient")
# 
# p2 = ggplot(profit_sensitivity, 
#             aes(precip_param2, profit)) + 
#   geom_point(cex=2) +
#   theme_light() +
#   labs(y="Profit", 
#        x="Precipitation Coefficient")
# 
# ggarrange(p1, p2)
```

```{r}
ggplot(profit_sensitivity, aes(x=almond_yield, y=profit)) +
  geom_point() +
  theme_light() +
  labs(x="Almond Yield", 
       y="Profit ($/acre)",
       title="Relationship Between Profit and Almond Yield")
```

```{r}
profit_sensitivity %>% filter(year != 1995) %>% ggplot(aes(x=factor(year), y=profit, group=year)) +
  geom_boxplot() +
  theme_light() +
  theme(axis.text.x = element_text(angle=90)) +
  labs(x="Year", y="Profit ($/acre)",
       title="Yearly Profit Distribution From Almond Yield Parameter Uncertainty")
```

